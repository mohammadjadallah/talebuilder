<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <title>TaleBuilder</title>
  <link rel="stylesheet" href="{{ url_for('.static', filename='css/createstory.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5); /* Adjust opacity as needed */
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10; /* Ensure it's above other content */
    }

    .loader {
      border: 16px solid #e2e2e2; /* Light grey */
      border-top: 16px solid #8426ff; /* Blue */
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 2s linear infinite;
    }

    .result-box {
      position: relative;
      min-height: 100px;
    }

    .voice-select {
      text-align: center;
      color: #fff;
      font-size: 25px;
      background-color: #0C0824;
      border: 2px solid #8426ff;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      cursor: pointer;
    }

    .voice-select option {
      color: #fff;
      padding: 10px;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo">
    </div>
    <div class="buttons">
      <button class="header-btn"><a class="link-page" href="{{ url_for('index') }}">Home</a></button>
      <button class="header-btn"><a class="link-page" href="{{ url_for('contactus') }}">Contact Us</a></button>
      <button class="header-btn"><a class="link-page" href="{{ url_for('about') }}">About</a></button>
    </div>
  </header>

  <div class="container">
    <div class="title-container">
      <h1 class="title-page">TaleBuilder</h1>
      <p class="para-page">This Is AI Tool For Converting Charts Of Data Scientists, Analysts Into Stories By The Power Of AI</p>
    </div>

    <div class="card">
      <div class="btns-settings">
        <label for="pdf-upload" class="custom-file-upload">Upload</label>
        <input type="file" id="pdf-upload" accept="image/*" title="Upload image">
        <button class="card-btn" id="process-btn">Make a Story</button>
        <button class="card-btn" id="speak-btn">Tell the Story</button>
        
          <select class="voice-select">
            <option value="Rachel">Rachel (Default)</option>
            <option value="Adam">Adam</option>
            <option value="Antoni">Antoni</option>
            <option value="Arnold">Arnold</option>
            <option value="Bella">Bella</option>
            <option value="Callum">Callum</option>
            <option value="Charlie">Charlie</option>
            <option value="Dorothy">Dorothy</option>
          </select>
      </div>

      <div class="boxes-settings">
        <div class="view-image" id="view-image">
          <span class="material-symbols-outlined">image</span>
        </div>
        <div id="result-box" class="result-box" contenteditable="true">
          <!-- Loading animation will be inserted here -->
        </div>
      </div>
    </div>

    <div class="footer">
      <p><b>&copy; 2024 TaleBuilder. All rights reserved.</b></p>
      <div>
        <a href="#" class="fa fa-instagram"></a>
        <a href="#" class="fa fa-facebook"></a>
        <a href="#" class="fa fa-linkedin"></a>
        <a href="#" class="fa fa-google"></a>
      </div>
    </div>
  </div>

  <script>
    document.getElementById('pdf-upload').addEventListener('change', (event) => {
      const file = event.target.files[0];
      const viewImage = document.getElementById('view-image');

      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          viewImage.innerHTML = `<img src="${e.target.result}" alt="Uploaded Image" style="max-width: 100%; height: auto;">`;
        };
        reader.readAsDataURL(file);
      } else {
        alert('Please upload a valid image file.');
      }
    });

    document.getElementById('process-btn').addEventListener('click', async () => {
      const fileInput = document.getElementById('pdf-upload');
      const file = fileInput.files[0];
      const resultBox = document.getElementById('result-box');

      if (file && file.type.startsWith('image/')) {
        const formData = new FormData();
        formData.append('image', file);

        // Show loading spinner/message
        resultBox.innerHTML = `
          <div class="loading-overlay">
            <div class="loader"></div>
          </div>
        `;

        try {
          const response = await fetch('/process_image', {
            method: 'POST',
            body: formData,
          });
          if (response.ok) {
            const result = await response.text();
            resultBox.innerHTML = result;
          } else {
            throw new Error('Failed to process image.');
          }
        } catch (error) {
          console.error('Error processing image:', error);
          alert('Error processing image. Please try again.');
        }
      } else {
        alert('Please upload a valid image file.');
      }
    });

    document.getElementById('speak-btn').addEventListener('click', async () => {
      const text = document.getElementById('result-box').innerText;
      const resultBox = document.getElementById('result-box');

      if (text) {
        // Show loading spinner/message
        const loadingSpinner = document.createElement('div');
        loadingSpinner.classList.add('loading-overlay');
        loadingSpinner.innerHTML = `
          <div class="loader"></div>
        `;
        resultBox.appendChild(loadingSpinner);

        setTimeout(() => {
          resultBox.removeChild(loadingSpinner);
        }, 25000); // 25 seconds

        const response = await fetch('/text_to_speech', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ text }),
        });

        if (response.ok) {
          console.log('Speech generation request sent successfully.');
        } else {
          const errorText = await response.text();
          console.error('Failed to generate speech:', errorText);
          alert('Failed to generate speech. Please try again.');
        }

      } else {
        alert('No text to speak.');
      }
    });
  </script>
</body>
</html>
